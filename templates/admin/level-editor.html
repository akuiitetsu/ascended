<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Editor - AscendEd Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <style>
        .nav-tab.active { 
            background-color: rgb(37 99 235);
            color: rgb(191 219 254);
            border-color: rgb(96 165 250);
        }
        .room-tab.active { 
            background-color: rgb(147 51 234);
            color: rgb(221 214 254);
            border-color: rgb(168 85 247);
        }
        .level-card { transition: all 0.2s ease; }
        .level-card:hover { transform: translateY(-2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-900 text-white font-mono">
    <header class="bg-gradient-to-r from-gray-900 via-green-900 to-blue-900 p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-3xl font-bold text-green-100">
                <i class="bi bi-gear"></i> Level Editor
            </h1>
            <div class="flex items-center space-x-4">
                <a href="/admin" class="bg-red-600 hover:bg-red-500 px-3 py-2 rounded transition-colors">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6">
        <!-- Main Navigation Tabs -->
        <div class="mb-6">
            <div class="flex space-x-2 border-b border-gray-700 overflow-x-auto">
                <button class="nav-tab px-4 py-2 rounded-t-lg transition-colors active" data-tab="editor">
                    <i class="bi bi-pencil-square"></i> Level Editor
                </button>
                <button class="nav-tab px-4 py-2 rounded-t-lg transition-colors" data-tab="guide">
                    <i class="bi bi-book"></i> Admin Guide
                </button>
            </div>
        </div>

        <!-- Level Editor Tab Content -->
        <div id="editor-tab" class="tab-content active">
            <!-- Room Tabs -->
            <div class="mb-6">
                <div class="flex space-x-2 border-b border-gray-700 overflow-x-auto">
                    <button class="room-tab px-4 py-2 rounded-t-lg transition-colors active whitespace-nowrap" data-room="1">
                        <i class="bi bi-diagram-3"></i> Flowchart Lab
                    </button>
                    <button class="room-tab px-4 py-2 rounded-t-lg transition-colors whitespace-nowrap" data-room="2">
                        <i class="bi bi-cloud"></i> Network Nexus
                    </button>
                    <button class="room-tab px-4 py-2 rounded-t-lg transition-colors whitespace-nowrap" data-room="3">
                        <i class="bi bi-robot"></i> AI Systems
                    </button>
                    <button class="room-tab px-4 py-2 rounded-t-lg transition-colors whitespace-nowrap" data-room="4">
                        <i class="bi bi-database-x"></i> Database Emergency
                    </button>
                    <button class="room-tab px-4 py-2 rounded-t-lg transition-colors whitespace-nowrap" data-room="5">
                        <i class="bi bi-bug"></i> Programming Crisis
                    </button>
                </div>
            </div>

            <!-- Level Management Panel -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Level List -->
                <div class="lg:col-span-2">
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-white">
                                <span id="current-room-title">Flowchart Lab</span> Levels
                            </h2>
                            <div class="flex space-x-2">
                                <button id="refresh-levels" class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded text-sm transition-colors">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button id="create-level" class="bg-green-600 hover:bg-green-500 px-3 py-2 rounded text-sm transition-colors">
                                    <i class="bi bi-plus"></i> New Level
                                </button>
                            </div>
                        </div>
                        
                        <div id="levels-container" class="space-y-3">
                            <!-- Levels will be loaded here -->
                            <div class="text-center py-8 text-gray-400">
                                <i class="bi bi-hourglass-split text-4xl mb-2"></i>
                                <p>Loading levels...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Level Editor Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-6">
                        <h3 class="text-lg font-bold text-white mb-4">Level Editor</h3>
                        
                        <form id="level-form" class="space-y-4">
                            <input type="hidden" id="level-id" value="">
                            <input type="hidden" id="room-id" value="1">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Level Number</label>
                                <input type="number" id="level-number" min="1" max="100" 
                                       class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Level Name</label>
                                <input type="text" id="level-name" 
                                       class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600" 
                                       placeholder="Enter level name" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Description</label>
                                <textarea id="level-description" rows="3" 
                                          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600"
                                          placeholder="Level description"></textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Difficulty</label>
                                <select id="level-difficulty" class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600">
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                    <option value="expert">Expert</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Level Data (JSON)</label>
                                <textarea id="level-data" rows="8" 
                                          class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 font-mono text-sm"
                                          placeholder='{"objectives": [], "hints": [], "validation": {}}'></textarea>
                            </div>
                            
                            <div class="flex space-x-2">
                                <button type="submit" id="save-level" class="flex-1 bg-green-600 hover:bg-green-500 px-4 py-2 rounded transition-colors">
                                    <i class="bi bi-save"></i> Save Level
                                </button>
                                <button type="button" id="clear-form" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded transition-colors">
                                    <i class="bi bi-x"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 mt-6">
                        <h3 class="text-lg font-bold text-white mb-4">Quick Actions</h3>
                        <div class="space-y-2">
                            <button id="export-room" class="w-full bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded text-sm transition-colors">
                                <i class="bi bi-download"></i> Export Room Levels
                            </button>
                            <button id="import-levels" class="w-full bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded text-sm transition-colors">
                                <i class="bi bi-upload"></i> Import Levels
                            </button>
                            <button id="populate-defaults" class="w-full bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded text-sm transition-colors">
                                <i class="bi bi-database-add"></i> Populate Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Guide Tab Content -->
        <div id="guide-tab" class="tab-content">
            <div class="bg-gray-800 border border-gray-600 rounded-lg p-6">
                <h2 class="text-2xl font-bold text-white mb-6">Level Editor Guide</h2>
                
                <div class="space-y-6">
                    <div class="bg-gray-700 p-4 rounded">
                        <h3 class="text-lg font-bold text-blue-400 mb-2">Room Structure</h3>
                        <ul class="text-gray-300 space-y-1">
                            <li><strong>Room 1:</strong> Flowchart Lab - Basic programming logic and flowchart creation</li>
                            <li><strong>Room 2:</strong> Network Nexus - Networking concepts and topology building</li>
                            <li><strong>Room 3:</strong> AI Systems - Artificial intelligence and machine learning</li>
                            <li><strong>Room 4:</strong> Database Emergency - SQL queries and database management</li>
                            <li><strong>Room 5:</strong> Programming Crisis - Advanced coding challenges</li>
                        </ul>
                    </div>
                    
                    <div class="bg-gray-700 p-4 rounded">
                        <h3 class="text-lg font-bold text-green-400 mb-2">Level Data Format</h3>
                        <pre class="text-gray-300 text-sm overflow-x-auto"><code>{
  "name": "Level Name",
  "description": "Level description",
  "difficulty": "easy|medium|hard|expert",
  "objectives": ["Objective 1", "Objective 2"],
  "hints": ["Hint 1", "Hint 2"],
  "validation": {
    "requiredNodes": ["type1", "type2"],
    "minConnections": 2,
    "customRules": {}
  },
  "rewards": {
    "points": 100,
    "badges": ["badge_id"]
  }
}</code></pre>
                    </div>
                    
                    <div class="bg-gray-700 p-4 rounded">
                        <h3 class="text-lg font-bold text-purple-400 mb-2">Best Practices</h3>
                        <ul class="text-gray-300 space-y-1">
                            <li>• Start with easy levels and gradually increase complexity</li>
                            <li>• Provide clear objectives and helpful hints</li>
                            <li>• Test levels thoroughly before publishing</li>
                            <li>• Use consistent naming conventions</li>
                            <li>• Include progressive skill building</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Import Modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 border border-gray-600 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold text-white mb-4">Import Levels</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">JSON Data</label>
                    <textarea id="import-data" rows="10" 
                              class="w-full p-2 rounded bg-gray-700 text-white border border-gray-600 font-mono text-sm"
                              placeholder="Paste level JSON data here"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="overwrite-existing" class="mr-2">
                    <label for="overwrite-existing" class="text-sm text-gray-300">Overwrite existing levels</label>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancel-import" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded transition-colors">Cancel</button>
                    <button id="confirm-import" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded transition-colors">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-gray-800 border border-red-600 rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold text-red-400 mb-4">Delete Level</h3>
            <p class="text-gray-300 mb-6" id="delete-message">Are you sure you want to delete this level?</p>
            <div class="flex justify-end space-x-2">
                <button id="cancel-delete" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded transition-colors">Cancel</button>
                <button id="confirm-delete" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded transition-colors">Delete</button>
            </div>
        </div>
    </div>

    <script>
        class LevelEditor {
            constructor() {
                this.currentRoom = 1;
                this.currentLevels = [];
                this.currentLevelId = null;
                this.roomNames = {
                    1: 'Flowchart Lab',
                    2: 'Network Nexus', 
                    3: 'AI Systems',
                    4: 'Database Emergency',
                    5: 'Programming Crisis'
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadRoomLevels(1);
            }

            setupEventListeners() {
                // Main tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchMainTab(tab.dataset.tab));
                });

                // Room tab navigation
                document.querySelectorAll('.room-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchRoom(parseInt(tab.dataset.room)));
                });

                // Level management
                document.getElementById('refresh-levels').addEventListener('click', () => this.loadRoomLevels(this.currentRoom));
                document.getElementById('create-level').addEventListener('click', () => this.createNewLevel());
                document.getElementById('level-form').addEventListener('submit', (e) => this.saveLevel(e));
                document.getElementById('clear-form').addEventListener('click', () => this.clearForm());

                // Quick actions
                document.getElementById('export-room').addEventListener('click', () => this.exportRoom());
                document.getElementById('import-levels').addEventListener('click', () => this.showImportModal());
                document.getElementById('populate-defaults').addEventListener('click', () => this.populateDefaults());

                // Import modal
                document.getElementById('cancel-import').addEventListener('click', () => this.hideImportModal());
                document.getElementById('confirm-import').addEventListener('click', () => this.importLevels());

                // Delete modal
                document.getElementById('cancel-delete').addEventListener('click', () => this.hideDeleteModal());
                document.getElementById('confirm-delete').addEventListener('click', () => this.confirmDeleteLevel());
            }

            switchMainTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Show/hide content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }

            switchRoom(roomId) {
                this.currentRoom = roomId;
                
                // Update room tab buttons
                document.querySelectorAll('.room-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-room="${roomId}"]`).classList.add('active');

                // Update room title
                document.getElementById('current-room-title').textContent = this.roomNames[roomId];
                document.getElementById('room-id').value = roomId;

                // Load levels for this room
                this.loadRoomLevels(roomId);
                this.clearForm();
            }

            async loadRoomLevels(roomId) {
                const container = document.getElementById('levels-container');
                container.innerHTML = '<div class="text-center py-4 text-gray-400">Loading levels...</div>';

                try {
                    const response = await fetch(`/api/admin/levels/${roomId}`);
                    const data = await response.json();

                    if (data.status === 'success') {
                        this.currentLevels = data.levels;
                        this.renderLevels();
                    } else {
                        container.innerHTML = '<div class="text-center py-4 text-red-400">Failed to load levels</div>';
                    }
                } catch (error) {
                    console.error('Error loading levels:', error);
                    container.innerHTML = '<div class="text-center py-4 text-red-400">Error loading levels</div>';
                }
            }

            renderLevels() {
                const container = document.getElementById('levels-container');
                
                if (this.currentLevels.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <i class="bi bi-inbox text-4xl mb-2"></i>
                            <p>No levels found for ${this.roomNames[this.currentRoom]}</p>
                            <button class="mt-3 bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm transition-colors" onclick="levelEditor.createNewLevel()">
                                Create First Level
                            </button>
                        </div>
                    `;
                    return;
                }

                const levelsHtml = this.currentLevels
                    .sort((a, b) => a.level_number - b.level_number)
                    .map(level => `
                        <div class="level-card bg-gray-700 border border-gray-600 rounded p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-blue-600 text-blue-100 px-2 py-1 rounded text-xs font-bold">
                                            Level ${level.level_number}
                                        </span>
                                        <span class="text-lg font-bold text-white">${level.name}</span>
                                    </div>
                                    
                                    ${level.data.description ? `
                                        <p class="text-sm text-gray-300 mb-2">${level.data.description}</p>
                                    ` : ''}
                                    
                                    <div class="flex items-center gap-4 text-xs text-gray-400">
                                        <span>
                                            <i class="bi bi-calendar"></i>
                                            Created: ${new Date(level.created_at).toLocaleDateString()}
                                        </span>
                                        ${level.updated_at !== level.created_at ? `
                                            <span>
                                                <i class="bi bi-pencil"></i>
                                                Updated: ${new Date(level.updated_at).toLocaleDateString()}
                                            </span>
                                        ` : ''}
                                    </div>
                                    
                                    ${level.data.difficulty ? `
                                        <div class="mt-2">
                                            <span class="inline-block px-2 py-1 rounded text-xs ${this.getDifficultyColor(level.data.difficulty)}">
                                                ${level.data.difficulty.toUpperCase()}
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="levelEditor.editLevel(${level.id})" 
                                            class="bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-xs transition-colors"
                                            title="Edit Level">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button onclick="levelEditor.duplicateLevel(${level.id})" 
                                            class="bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-xs transition-colors"
                                            title="Duplicate Level">
                                        <i class="bi bi-files"></i>
                                    </button>
                                    <button onclick="levelEditor.deleteLevel(${level.id}, '${level.name.replace(/'/g, "\\'")}', ${level.level_number})" 
                                            class="bg-red-600 hover:bg-red-500 px-3 py-1 rounded text-xs transition-colors"
                                            title="Delete Level">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mt-3 pt-3 border-t border-gray-600">
                                <div class="grid grid-cols-2 gap-4 text-xs text-gray-400">
                                    <div>
                                        <span class="font-medium">Objectives:</span>
                                        <span>${level.data.objectives ? level.data.objectives.length : 0}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">Hints:</span>
                                        <span>${level.data.hints ? level.data.hints.length : 0}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">Validation Rules:</span>
                                        <span>${level.data.validation ? Object.keys(level.data.validation).length : 0}</span>
                                    </div>
                                    <div>
                                        <span class="font-medium">Data Size:</span>
                                        <span>${this.formatDataSize(JSON.stringify(level.data).length)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');

                container.innerHTML = levelsHtml;
            }

            getDifficultyColor(difficulty) {
                const colors = {
                    'easy': 'bg-green-600 text-green-100',
                    'medium': 'bg-yellow-600 text-yellow-100',
                    'hard': 'bg-orange-600 text-orange-100',
                    'expert': 'bg-red-600 text-red-100'
                };
                return colors[difficulty] || 'bg-gray-600 text-gray-100';
            }

            formatDataSize(bytes) {
                if (bytes < 1024) return `${bytes}B`;
                if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)}KB`;
                return `${(bytes / (1024 * 1024)).toFixed(1)}MB`;
            }

            createNewLevel() {
                this.clearForm();
                const nextLevelNumber = Math.max(...this.currentLevels.map(l => l.level_number), 0) + 1;
                document.getElementById('level-number').value = nextLevelNumber;
                document.getElementById('level-data').value = JSON.stringify({
                    description: "",
                    difficulty: "easy",
                    objectives: [],
                    hints: [],
                    validation: {},
                    rewards: { points: 100 }
                }, null, 2);
            }

            editLevel(levelId) {
                const level = this.currentLevels.find(l => l.id === levelId);
                if (!level) return;

                this.currentLevelId = levelId;
                document.getElementById('level-id').value = level.id;
                document.getElementById('level-number').value = level.level_number;
                document.getElementById('level-name').value = level.name;
                document.getElementById('level-data').value = JSON.stringify(level.data, null, 2);

                // Extract additional fields from level data
                if (level.data.description) {
                    document.getElementById('level-description').value = level.data.description;
                }
                if (level.data.difficulty) {
                    document.getElementById('level-difficulty').value = level.data.difficulty;
                }

                // Scroll to form
                document.getElementById('level-form').scrollIntoView({ behavior: 'smooth' });
            }

            async duplicateLevel(levelId) {
                const level = this.currentLevels.find(l => l.id === levelId);
                if (!level) return;

                const nextLevelNumber = Math.max(...this.currentLevels.map(l => l.level_number), 0) + 1;
                
                const duplicatedLevel = {
                    room_id: this.currentRoom,
                    level_number: nextLevelNumber,
                    name: `${level.name} (Copy)`,
                    data: { ...level.data }
                };

                try {
                    const response = await fetch('/api/admin/levels', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(duplicatedLevel)
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        this.showMessage('Level duplicated successfully', 'success');
                        this.loadRoomLevels(this.currentRoom);
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Failed to duplicate level', 'error');
                }
            }

            deleteLevel(levelId, levelName, levelNumber) {
                this.currentLevelId = levelId;
                document.getElementById('delete-message').textContent = 
                    `Are you sure you want to delete "Level ${levelNumber}: ${levelName}"? This action cannot be undone.`;
                this.showDeleteModal();
            }

            async confirmDeleteLevel() {
                if (!this.currentLevelId) return;

                try {
                    const response = await fetch(`/api/admin/levels/${this.currentLevelId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        this.showMessage(result.message, 'success');
                        this.loadRoomLevels(this.currentRoom);
                        this.hideDeleteModal();
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Failed to delete level', 'error');
                }
            }

            async saveLevel(event) {
                event.preventDefault();

                const levelId = document.getElementById('level-id').value;
                const levelData = {
                    room_id: this.currentRoom,
                    level_number: parseInt(document.getElementById('level-number').value),
                    name: document.getElementById('level-name').value,
                    data: {}
                };

                // Parse JSON data
                try {
                    const jsonData = JSON.parse(document.getElementById('level-data').value || '{}');
                    levelData.data = {
                        ...jsonData,
                        description: document.getElementById('level-description').value,
                        difficulty: document.getElementById('level-difficulty').value
                    };
                } catch (error) {
                    this.showMessage('Invalid JSON data', 'error');
                    return;
                }

                try {
                    let response;
                    if (levelId) {
                        // Update existing level
                        response = await fetch(`/api/admin/levels/${levelId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(levelData)
                        });
                    } else {
                        // Create new level
                        response = await fetch('/api/admin/levels', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(levelData)
                        });
                    }

                    const result = await response.json();
                    if (result.status === 'success') {
                        this.showMessage(result.message, 'success');
                        this.loadRoomLevels(this.currentRoom);
                        this.clearForm();
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Failed to save level', 'error');
                }
            }

            clearForm() {
                document.getElementById('level-form').reset();
                document.getElementById('level-id').value = '';
                document.getElementById('room-id').value = this.currentRoom;
                this.currentLevelId = null;
            }

            async exportRoom() {
                try {
                    window.location.href = `/api/admin/export-levels/${this.currentRoom}`;
                    this.showMessage(`Exporting ${this.roomNames[this.currentRoom]} levels...`, 'success');
                } catch (error) {
                    this.showMessage('Failed to export levels', 'error');
                }
            }

            showImportModal() {
                document.getElementById('import-modal').classList.remove('hidden');
                document.getElementById('import-modal').classList.add('flex');
            }

            hideImportModal() {
                document.getElementById('import-modal').classList.add('hidden');
                document.getElementById('import-modal').classList.remove('flex');
                document.getElementById('import-data').value = '';
                document.getElementById('overwrite-existing').checked = false;
            }

            showDeleteModal() {
                document.getElementById('delete-modal').classList.remove('hidden');
                document.getElementById('delete-modal').classList.add('flex');
            }

            hideDeleteModal() {
                document.getElementById('delete-modal').classList.add('hidden');
                document.getElementById('delete-modal').classList.remove('flex');
                this.currentLevelId = null;
            }

            async importLevels() {
                const importData = document.getElementById('import-data').value;
                const overwrite = document.getElementById('overwrite-existing').checked;

                try {
                    const levelsData = JSON.parse(importData);
                    
                    const response = await fetch('/api/admin/import-levels', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            room_id: this.currentRoom,
                            levels: levelsData.levels || levelsData,
                            overwrite: overwrite
                        })
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        this.showMessage(result.message, 'success');
                        this.loadRoomLevels(this.currentRoom);
                        this.hideImportModal();
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Invalid JSON data or import failed', 'error');
                }
            }

            async populateDefaults() {
                if (!confirm(`Populate default levels for ${this.roomNames[this.currentRoom]}?`)) return;

                try {
                    const response = await fetch('/api/admin/levels/populate-defaults', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ room_id: this.currentRoom })
                    });

                    const result = await response.json();
                    this.showMessage(result.message, result.status === 'success' ? 'success' : 'info');
                    if (result.status === 'success') {
                        this.loadRoomLevels(this.currentRoom);
                    }
                } catch (error) {
                    this.showMessage('Failed to populate defaults', 'error');
                }
            }

            showMessage(message, type = 'info') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded text-white ${
                    type === 'error' ? 'bg-red-600' : 
                    type === 'success' ? 'bg-green-600' : 
                    'bg-blue-600'
                }`;
                messageDiv.textContent = message;
                
                document.body.appendChild(messageDiv);
                setTimeout(() => messageDiv.remove(), 4000);
            }
        }

        // Initialize level editor
        const levelEditor = new LevelEditor();
        window.levelEditor = levelEditor; // Make available globally
    </script>
</body>
</html>
                        <label class="block text-sm font-medium mb-2">Level Name</label>
                        <input type="text" name="name" required
                               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white"
                               placeholder="Enter a descriptive name for this level">
                    </div>
                    <div class="bg-blue-900 border border-blue-600 rounded-lg p-3">
                        <div class="flex items-center">
                            <i class="bi bi-info-circle text-blue-400 mr-2"></i>
                            <span class="text-sm text-blue-200">Level number will be assigned automatically</span>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded transition-colors">
                            Create Level
                        </button>
                        <button type="button" id="cancel-create" class="flex-1 bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Levels Modal -->
    <div id="import-levels-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Import Levels</h3>
            <form id="import-levels-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">JSON Data</label>
                        <textarea name="json_data" rows="10" required
                                  class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white font-mono text-sm"
                                  placeholder='{"levels": [{"level_number": 1, "name": "Level Name", "data": {...}}]}'></textarea>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="overwrite" class="mr-2">
                            <span class="text-sm">Overwrite existing levels</span>
                        </label>
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded transition-colors">
                            Import Levels
                        </button>
                        <button type="button" id="cancel-import" class="flex-1 bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add SortableJS for drag and drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Add enhanced reorder handling to the existing level-editor.js functionality
        
        // Enhanced error handling for reorder operations
        window.handleReorderError = function(error) {
            console.error('Reorder error:', error);
            
            // Show user-friendly error message
            const errorMessage = error.message || 'Failed to reorder levels';
            
            // Create error notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="bi bi-exclamation-triangle mr-2"></i>
                    <span>Reorder failed: ${errorMessage}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
            
            // Reload levels to reset the order
            if (window.levelEditor && window.levelEditor.loadLevels) {
                window.levelEditor.loadLevels();
            }
        };
        
        // Enhanced success handling for reorder operations
        window.handleReorderSuccess = function(message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="bi bi-check-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        };
    </script>
    <script src="/static/js/admin/level-editor.js"></script>
</body>
</html>
